---
phase: 04-mcp-server
plan: 03
type: execute
wave: 3
depends_on: [04-01]
files_modified:
  - mcp_server.py
  - app.py
autonomous: true

must_haves:
  truths:
    - "search_youtube_content tool accepts query string and optional max_results parameter"
    - "search_youtube_content tool uses YouTube Search API to find videos"
    - "search_youtube_content tool returns list of videos with video_id, title, thumbnail, description"
    - "search_youtube_content tool defaults to 10 results (max 50)"
    - "search_youtube_content tool includes quota_cost=100 in response (API is expensive)"
    - "Tool description clearly indicates 100 quota unit cost per search"
    - "Returned video IDs can be used with analyze_video tool"
  artifacts:
    - path: "app.py"
      provides: "search_youtube_videos function using YouTube Search API"
      exports: ["search_youtube_videos"]
      min_lines: 50
    - path: "mcp_server.py"
      provides: "search_youtube_content MCP tool"
      exports: ["search_youtube_content"]
      min_lines: 40
  key_links:
    - from: "mcp_server.py search_youtube_content tool"
      to: "app.py search_youtube_videos"
      via: "import and function call"
      pattern: "from app import search_youtube_videos"
    - from: "app.py search_youtube_videos"
      to: "YouTube Search API"
      via: "youtube.search().list() call"
      pattern: "youtube\\.search\\(\\)\\.list"
    - from: "search_youtube_content tool"
      to: "analyze_video tool"
      via: "workflow guidance in description"
      pattern: "analyze_video"
---

<objective>
Implement search_youtube_content MCP tool that finds YouTube videos by keyword using the YouTube Search API.

Purpose: Enable AI agents to discover YouTube content through keyword search, with results that can be analyzed using the analyze_video tool.
Output: Working search_youtube_content MCP tool that returns video search results with metadata and quota cost tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-mcp-server/04-CONTEXT.md
@app.py
@.planning/phases/04-mcp-server/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add search_youtube_videos function to app.py</name>
  <files>app.py</files>
  <action>
    Add a new function `search_youtube_videos(query, max_results=10)` to app.py after the get_comments_for_video() function.

    The function should:
    1. Use @lru_cache(maxsize=50) decorator for caching (lower cache size since search queries vary more)
    2. Validate query is not empty/None (raise ValueError if so)
    3. Validate max_results is between 1 and 50 (clamp to this range)
    4. Call youtube.search().list() with:
       - part='snippet'
       - q=query
       - type='video'
       - maxResults=max_results
       - order='relevance' (most relevant first)
    5. Extract from response['items']:
       - video_id (item['id']['videoId'])
       - title (item['snippet']['title'])
       - description (item['snippet']['description'])
       - thumbnail (item['snippet']['thumbnails']['default']['url'] or fallback)
       - channel_title (item['snippet']['channelTitle'])
       - published_at (item['snippet']['publishedAt'])
    6. Return list of video objects with these fields
    7. Handle HttpError for quota exceeded (403) and other errors

    Place the function after get_comments_for_video (around line 270-280).

    Note: YouTube Search API costs 100 quota units per request. This is expensive!
  </action>
  <verify>grep -q "def search_youtube_videos" app.py && grep -q "youtube.search()" app.py</verify>
  <done>app.py has search_youtube_videos() function that searches YouTube by query and returns list of video metadata</done>
</task>

<task type="auto">
  <name>Implement search_youtube_content MCP tool in mcp_server.py</name>
  <files>mcp_server.py</files>
  <action>
    Add the search_youtube_content MCP tool to mcp_server.py:

    1. Import search_youtube_videos from app.py
    2. Implement @mcp.tool decorated search_youtube_content(query: str, max_results: int = 10) -> dict function:
       - Call search_youtube_videos(query, max_results)
       - Build result dict with:
         - success (bool)
         - query (str) - the search query
         - result_count (int) - number of videos returned
         - quota_cost (int) - set to 100 (expensive API!)
         - videos (list) - list of video objects from search
         - workflow_hint (str) - "Use analyze_video() with these video IDs to get full data"
       - Handle errors (empty query, API errors) with user-friendly messages

    Tool metadata:
       - Add description: "Search YouTube videos by keyword. WARNING: Expensive operation (100 YouTube API quota units). Returns video list with IDs, titles, thumbnails, descriptions. Use analyze_video() with video IDs to get complete transcript, metadata, statistics, and comments."
       - Add parameter schema:
         - query (string, required) - "Search query for finding videos"
         - max_results (integer, optional, default=10, min=1, max=50) - "Maximum number of results to return (1-50)"

    Add this tool after the analyze_video tool definition.
  </action>
  <verify>grep -q "def search_youtube_content" mcp_server.py && grep -q "quota_cost.*100" mcp_server.py</verify>
  <done>mcp_server.py has search_youtube_content tool that searches YouTube, returns video list with quota_cost=100, and guides users to analyze_video</done>
</task>

<task type="auto">
  <name>Test search_youtube_content tool</name>
  <files>None (testing)</files>
  <action>
    Test the search_youtube_content tool:

    1. Start MCP server: `python mcp_server.py`
    2. Test with a simple query: `python -c "from mcp_server import search_youtube_content; result = search_youtube_content('python tutorial'); print(result)"`
    3. Verify response structure includes:
       - success: True
       - query: "python tutorial"
       - result_count: between 1 and 10
       - quota_cost: 100
       - videos: list with video_id, title, description, thumbnail
       - workflow_hint: mentions analyze_video
    4. Test max_results parameter: search_youtube_content('test', max_results=5)
    5. Test invalid query (empty string): verify error handling
    6. Verify video IDs from results can be used with analyze_video tool

    This confirms the tool works correctly and integrates with analyze_video for workflow completion.
  </action>
  <verify>python -c "from mcp_server import search_youtube_content; result = search_youtube_content('test'); print('quota_cost' in result and 'videos' in result)"</verify>
  <done>search_youtube_content tool returns valid search results with video IDs that work with analyze_video</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `python -c "from app import search_youtube_videos; print('Function imported')"` - no import errors
2. Search function works: `python -c "from app import search_youtube_videos; results = search_youtube_videos('test', 5); print(len(results) <= 5)"` - returns <= 5 results
3. Tool is registered: Check MCP tools list includes search_youtube_content
4. Test search query: Call search_youtube_content('python programming') and verify returns video list
5. Verify quota cost: Response includes quota_cost=100
6. Verify workflow hint: Response mentions analyze_video for getting full data
7. Test edge cases: empty query (error), max_results=0 (clamped to 1), max_results=100 (clamped to 50)
</verification>

<success_criteria>
1. search_youtube_videos() function uses YouTube Search API with correct parameters
2. Function returns list of videos with video_id, title, description, thumbnail
3. Function validates query and max_results parameters
4. search_youtube_content MCP tool wraps the function and adds MCP metadata
5. Tool clearly warns about 100 quota unit cost in description
6. Returned video IDs can be passed to analyze_video tool
7. Workflow hint guides users from search to analysis
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server/04-03-SUMMARY.md` with:
- Search API integration details
- Quota cost tracking (100 units per search)
- Test results with example queries
- Integration with analyze_video workflow
- Any edge cases handled (empty query, invalid max_results)
</output>
