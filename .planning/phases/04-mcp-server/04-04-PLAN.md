---
phase: 04-mcp-server
plan: 04
type: execute
wave: 4
depends_on: [04-01]
files_modified:
  - mcp_server.py
  - app.py
autonomous: true

must_haves:
  truths:
    - "get_channel_overview tool accepts channel ID or URL as parameter"
    - "get_channel_overview tool extracts channel ID from full YouTube URLs automatically"
    - "get_channel_overview tool returns channel information (title, description, subscriber count)"
    - "get_channel_overview tool returns recent uploads from the channel"
    - "Tool is registered with MCP and discoverable via /mcp/tools/list"
    - "Tool handles missing channel data gracefully with clear error messages"
    - "Channel uploads are limited to 10 most recent videos"
  artifacts:
    - path: "app.py"
      provides: "get_channel_info and get_channel_uploads functions"
      exports: ["get_channel_info", "get_channel_uploads"]
      min_lines: 80
    - path: "mcp_server.py"
      provides: "get_channel_overview MCP tool"
      exports: ["get_channel_overview"]
      min_lines: 50
  key_links:
    - from: "mcp_server.py get_channel_overview tool"
      to: "app.py get_channel_info"
      via: "import and function call"
      pattern: "from app import get_channel_info|get_channel_uploads"
    - from: "app.py get_channel_info"
      to: "YouTube Channels API"
      via: "youtube.channels().list() call"
      pattern: "youtube\\.channels\\(\\)\\.list"
    - from: "app.py get_channel_uploads"
      to: "YouTube Search API"
      via: "youtube.search().list() call"
      pattern: "youtube\\.search\\(\\)\\.list"
---

<objective>
Implement get_channel_overview MCP tool that fetches channel information and recent uploads.

Purpose: Enable AI agents to retrieve YouTube channel profiles and discover content from specific channels through a single tool call.
Output: Working get_channel_overview MCP tool that returns channel metadata and recent video uploads.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-mcp-server/04-CONTEXT.md
@app.py
@.planning/phases/04-mcp-server/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add get_channel_info function to app.py</name>
  <files>app.py</files>
  <action>
    Add a new function `get_channel_info(channel_id)` to app.py after the search_youtube_videos() function.

    The function should:
    1. Use @lru_cache(maxsize=100) decorator for caching
    2. Validate channel_id is not empty (raise ValueError if so)
    3. Call youtube.channels().list() with:
       - part='snippet,statistics'
       - id=channel_id
    4. Extract from response['items'][0]:
       - channel_id (item['id'])
       - title (item['snippet']['title'])
       - description (item['snippet']['description'])
       - subscriber_count (int(item['statistics']['subscriberCount']))
       - video_count (int(item['statistics']['videoCount']))
       - view_count (int(item['statistics']['viewCount']))
       - created_at (item['snippet']['publishedAt'])
       - thumbnail (item['snippet']['thumbnails']['default']['url'] or fallback)
    5. Return dict with all these fields
    6. Handle HttpError for channel not found (404) and other errors
    7. Handle case where response['items'] is empty (channel not found)

    Place the function after search_youtube_videos (around line 320).
  </action>
  <verify>grep -q "def get_channel_info" app.py && grep -q "youtube.channels()" app.py</verify>
  <done>app.py has get_channel_info() function that fetches channel metadata from YouTube Channels API</done>
</task>

<task type="auto">
  <name>Add get_channel_uploads function to app.py</name>
  <files>app.py</files>
  <action>
    Add a new function `get_channel_uploads(channel_id, max_results=10)` to app.py after the get_channel_info() function.

    The function should:
    1. Use @lru_cache(maxsize=50) decorator for caching
    2. Validate max_results is between 1 and 50 (clamp to this range)
    3. Call youtube.search().list() with:
       - part='snippet'
       - channelId=channel_id
       - type='video'
       - order='date' (most recent first)
       - maxResults=max_results
    4. Extract from response['items']:
       - video_id (item['id']['videoId'])
       - title (item['snippet']['title'])
       - description (item['snippet']['description'])
       - thumbnail (item['snippet']['thumbnails']['default']['url'])
       - published_at (item['snippet']['publishedAt'])
    5. Return list of video objects with these fields
    6. Handle errors (channel not found, API errors)

    Place the function after get_channel_info (around line 360).
  </action>
  <verify>grep -q "def get_channel_uploads" app.py</verify>
  <done>app.py has get_channel_uploads() function that fetches recent videos from a channel</done>
</task>

<task type="auto">
  <name>Implement get_channel_overview MCP tool in mcp_server.py</name>
  <files>mcp_server.py</files>
  <action>
    Add the get_channel_overview MCP tool to mcp_server.py:

    1. Import get_channel_info and get_channel_uploads from app.py
    2. Import re for regex-based channel ID extraction
    3. Create a helper function extract_channel_id(channel_url_or_id) that:
       - Checks if input looks like a channel ID (starts with UC, 24 chars)
       - If not, extracts channel ID from YouTube URLs using regex patterns:
         - Handle /channel/<CHANNEL_ID> URLs: r'youtube\.com\/channel\/([UC][A-Za-z0-9_-]{22})'
         - Handle /c/<CUSTOM_USERNAME> URLs: r'youtube\.com\/c\/([A-Za-z0-9_-]+)' (requires API lookup, skip for MVP - raise error)
         - Handle /@<HANDLE> URLs: r'youtube\.com\/@([A-Za-z0-9_.-]+)' (requires API lookup, skip for MVP - raise error)
       - Returns extracted channel ID or raises ValueError with clear message
    4. Implement @mcp.tool decorated get_channel_overview(channel_url_or_id: str, max_uploads: int = 10) -> dict function:
       - Extract channel ID using helper function
       - Call get_channel_info(channel_id) to get channel metadata
       - Call get_channel_uploads(channel_id, max_uploads) to get recent videos
       - Build result dict with:
         - success (bool)
         - channel (dict) - channel info from get_channel_info
         - uploads (list) - recent videos from get_channel_uploads
         - upload_count (int) - number of uploads returned
         - quota_cost (int) - set to 2 (1 for channel info, 1 for uploads search)
         - workflow_hint (str) - "Use analyze_video() with upload video IDs to get full transcript and metadata"
       - Handle errors (channel not found, API errors) with user-friendly messages

    Tool metadata:
       - Add description: "Fetch YouTube channel information and recent uploads. Accepts channel URL or ID. Returns channel metadata (title, description, subscriber count) and most recent videos. Use analyze_video() with video IDs to get complete transcript, metadata, and statistics."
       - Add parameter schema:
         - channel_url_or_id (string, required) - "YouTube channel URL or channel ID (starts with 'UC')"
         - max_uploads (integer, optional, default=10, min=1, max=50) - "Maximum number of recent uploads to return (1-50)"

    Add this tool after the search_youtube_content tool definition.
  </action>
  <verify>grep -q "def get_channel_overview" mcp_server.py && grep -q "extract_channel_id" mcp_server.py</verify>
  <done>mcp_server.py has get_channel_overview tool that fetches channel info and uploads, handles channel ID extraction, and guides users to analyze_video</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `python -c "from app import get_channel_info, get_channel_uploads; print('Functions imported')"` - no import errors
2. Channel info function works: Test with known channel ID (e.g., UCEgdi0XIXXZ-qJOHPf3Jxxw for Microsoft)
3. Channel uploads function works: Verify returns list of recent videos
4. Tool is registered: Check MCP tools list includes get_channel_overview
5. Channel ID extraction: Test with full channel URL and bare channel ID
6. Verify quota cost: Response includes quota_cost=2
7. Verify workflow hint: Response mentions analyze_video for getting full data from uploads
</verification>

<success_criteria>
1. get_channel_info() function fetches channel metadata from YouTube Channels API
2. get_channel_uploads() function fetches recent videos using YouTube Search API
3. Both functions handle errors (channel not found, API quota exceeded)
4. get_channel_overview MCP tool combines channel info and uploads in one call
5. Tool extracts channel ID from various YouTube URL formats
6. Tool returns structured response with channel data and recent uploads
7. Workflow hint guides users from channel overview to video analysis
8. Quota cost is tracked (2 units: 1 for channel info, 1 for uploads search)
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server/04-04-SUMMARY.md` with:
- Channel API integration details
- Channel ID extraction regex patterns
- Test results with example channels
- Integration with analyze_video workflow
- Quota cost breakdown
- Any limitations (e.g., custom URLs/handles not supported in MVP)
</output>
